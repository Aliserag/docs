"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[8023],{3905:(t,e,n)=>{n.d(e,{Zo:()=>p,kt:()=>m});var o=n(67294);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function l(t,e){if(null==t)return{};var n,o,a=function(t,e){if(null==t)return{};var n,o,a={},r=Object.keys(t);for(o=0;o<r.length;o++)n=r[o],e.indexOf(n)>=0||(a[n]=t[n]);return a}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(o=0;o<r.length;o++)n=r[o],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}var s=o.createContext({}),c=function(t){var e=o.useContext(s),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},p=function(t){var e=c(t.components);return o.createElement(s.Provider,{value:e},t.children)},h="mdxType",u={inlineCode:"code",wrapper:function(t){var e=t.children;return o.createElement(o.Fragment,{},e)}},d=o.forwardRef((function(t,e){var n=t.components,a=t.mdxType,r=t.originalType,s=t.parentName,p=l(t,["components","mdxType","originalType","parentName"]),h=c(n),d=a,m=h["".concat(s,".").concat(d)]||h[d]||u[d]||r;return n?o.createElement(m,i(i({ref:e},p),{},{components:n})):o.createElement(m,i({ref:e},p))}));function m(t,e){var n=arguments,a=e&&e.mdxType;if("string"==typeof t||a){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var s in e)hasOwnProperty.call(e,s)&&(l[s]=e[s]);l.originalType=t,l[h]="string"==typeof t?t:a,i[1]=l;for(var c=2;c<r;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},92048:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var o=n(87462),a=(n(67294),n(3905));const r={title:"9. Voting Contract"},i=void 0,l={unversionedId:"cadence/tutorial/voting",id:"cadence/tutorial/voting",title:"9. Voting Contract",description:"In this tutorial, we're going to deploy a contract that allows users to vote on multiple proposals that a voting administrator controls.",source:"@site/docs/cadence/tutorial/09-voting.mdx",sourceDirName:"cadence/tutorial",slug:"/cadence/tutorial/voting",permalink:"/docs/next/cadence/tutorial/voting",draft:!1,tags:[],version:"current",lastUpdatedBy:"Alex",lastUpdatedAt:1683049658,formattedLastUpdatedAt:"May 2, 2023",sidebarPosition:9,frontMatter:{title:"9. Voting Contract"},sidebar:"tutorialSidebar",previous:{title:"8. Marketplace",permalink:"/docs/next/cadence/tutorial/marketplace-compose"},next:{title:"10. Composable Resources",permalink:"/docs/next/cadence/tutorial/resources-compose"}},s={},c=[{value:"A Voting Contract in Cadence",id:"a-voting-contract-in-cadence",level:2},{value:"Deploy the Contract",id:"deploy-the-contract",level:2},{value:"Perform Voting",id:"perform-voting",level:2},{value:"Selecting multiple Accounts as Signers",id:"selecting-multiple-accounts-as-signers",level:2},{value:"Casting a Vote",id:"casting-a-vote",level:2},{value:"Reading the result of the vote",id:"reading-the-result-of-the-vote",level:2},{value:"Other Voting possibilities",id:"other-voting-possibilities",level:2}],p=(h="Callout",function(t){return console.warn("Component "+h+" was not imported, exported, or provided by MDXProvider as global scope"),(0,a.kt)("div",t)});var h;const u={toc:c},d="wrapper";function m(t){let{components:e,...n}=t;return(0,a.kt)(d,(0,o.Z)({},u,n,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"In this tutorial, we're going to deploy a contract that allows users to vote on multiple proposals that a voting administrator controls."),(0,a.kt)("hr",null),(0,a.kt)(p,{type:"success",mdxType:"Callout"},"Open the starter code for this tutorial in the Flow Playground:",(0,a.kt)("a",{href:"https://play.onflow.org/d120f0a7-d411-4243-bc59-5125a84f99b3",target:"_blank"},"https://play.onflow.org/d120f0a7-d411-4243-bc59-5125a84f99b3"),(0,a.kt)("br",null),"The tutorial will be asking you to take various actions to interact with this code."),(0,a.kt)(p,{type:"info",mdxType:"Callout"},"Instructions that require you to take action are always included in a callout box like this one. These highlighted actions are all that you need to do to get your code running, but reading the rest is necessary to understand the language's design."),(0,a.kt)("p",null,"With the advent of blockchain technology and smart contracts,\nit has become popular to try to create decentralized voting mechanisms that allow large groups of users to vote completely on chain.\nThis tutorial will provide a trivial example for how this might be achieved by using a resource-oriented programming model."),(0,a.kt)("p",null,"We'll take you through these steps to get comfortable with the Voting contract."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Deploy the contract to account 1"),(0,a.kt)("li",{parentName:"ol"},"Create proposals for users to vote on"),(0,a.kt)("li",{parentName:"ol"},"Use a transaction with multiple signers to directly transfer the ",(0,a.kt)("inlineCode",{parentName:"li"},"Ballot")," resource to another account."),(0,a.kt)("li",{parentName:"ol"},"Record and cast your vote in the central Voting contract"),(0,a.kt)("li",{parentName:"ol"},"Read the results of the vote")),(0,a.kt)("p",null,"Before proceeding with this tutorial, we highly recommend following the instructions in ",(0,a.kt)("a",{parentName:"p",href:"01-first-steps"},"Getting Started"),"\nand ",(0,a.kt)("a",{parentName:"p",href:"02-hello-world"},"Hello, World!")," to learn how to use the Playground tools and to learn the fundamentals of Cadence."),(0,a.kt)("h2",{id:"a-voting-contract-in-cadence"},"A Voting Contract in Cadence"),(0,a.kt)("p",null,"In this contract, a Ballot is represented as a resource.\nAn administrator can give Ballots to other accounts,\nthen those account mark which proposals they vote for\nand submit the Ballot to the central smart contract to have their votes recorded.\nUsing a resource type is logical for this application,\nbecause if a user wants to delegate their vote,\nthey can send that Ballot to another account."),(0,a.kt)("h2",{id:"deploy-the-contract"},"Deploy the Contract"),(0,a.kt)(p,{type:"info",mdxType:"Callout"},(0,a.kt)("p",null,"Open Account ",(0,a.kt)("inlineCode",{parentName:"p"},"0x01")," which has the ",(0,a.kt)("inlineCode",{parentName:"p"},"ApprovalVoting")," contract.",(0,a.kt)("br",null),"\nClick the Deploy button to deploy it to account ",(0,a.kt)("inlineCode",{parentName:"p"},"0x01"),'"')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cadence:title=ApprovalVoting.cdc"},'/*\n*\n*   In this example, we want to create a simple approval voting contract\n*   where a polling place issues ballots to addresses.\n*\n*   The run a vote, the Admin deploys the smart contract,\n*   then initializes the proposals\n*   using the initialize_proposals.cdc transaction.\n*   The array of proposals cannot be modified after it has been initialized.\n*\n*   Then they will give ballots to users by\n*   using the issue_ballot.cdc transaction.\n*\n*   Every user with a ballot is allowed to approve any number of proposals.\n*   A user can choose their votes and cast them\n*   with the cast_vote.cdc transaction.\n*\n*/\n\npub contract ApprovalVoting {\n\n    //list of proposals to be approved\n    pub var proposals: [String]\n\n    // number of votes per proposal\n    pub let votes: {Int: Int}\n\n    // This is the resource that is issued to users.\n    // When a user gets a Ballot object, they call the `vote` function\n    // to include their votes, and then cast it in the smart contract\n    // using the `cast` function to have their vote included in the polling\n    pub resource Ballot {\n\n        // array of all the proposals\n        pub let proposals: [String]\n\n        // corresponds to an array index in proposals after a vote\n        pub var choices: {Int: Bool}\n\n        init() {\n            self.proposals = ApprovalVoting.proposals\n            self.choices = {}\n\n            // Set each choice to false\n            var i = 0\n            while i < self.proposals.length {\n                self.choices[i] = false\n                i = i + 1\n            }\n        }\n\n        // modifies the ballot\n        // to indicate which proposals it is voting for\n        pub fun vote(proposal: Int) {\n            pre {\n                self.proposals[proposal] != nil: "Cannot vote for a proposal that doesn\'t exist"\n            }\n            self.choices[proposal] = true\n        }\n    }\n\n    // Resource that the Administrator of the vote controls to\n    // initialize the proposals and to pass out ballot resources to voters\n    pub resource Administrator {\n\n        // function to initialize all the proposals for the voting\n        pub fun initializeProposals(_ proposals: [String]) {\n            pre {\n                ApprovalVoting.proposals.length == 0: "Proposals can only be initialized once"\n                proposals.length > 0: "Cannot initialize with no proposals"\n            }\n            ApprovalVoting.proposals = proposals\n\n            // Set each tally of votes to zero\n            var i = 0\n            while i < proposals.length {\n                ApprovalVoting.votes[i] = 0\n                i = i + 1\n            }\n        }\n\n        // The admin calls this function to create a new Ballot\n        // that can be transferred to another user\n        pub fun issueBallot(): @Ballot {\n            return <-create Ballot()\n        }\n    }\n\n    // A user moves their ballot to this function in the contract where\n    // its votes are tallied and the ballot is destroyed\n    pub fun cast(ballot: @Ballot) {\n        var index = 0\n        // look through the ballot\n        while index < self.proposals.length {\n            if ballot.choices[index]! {\n                // tally the vote if it is approved\n                self.votes[index] = self.votes[index]! + 1\n            }\n            index = index + 1;\n        }\n        // Destroy the ballot because it has been tallied\n        destroy ballot\n    }\n\n    // initializes the contract by setting the proposals and votes to empty\n    // and creating a new Admin resource to put in storage\n    init() {\n        self.proposals = []\n        self.votes = {}\n\n        self.account.save<@Administrator>(<-create Administrator(), to: /storage/VotingAdmin)\n    }\n}\n\n')),(0,a.kt)("p",null,"This contract implements a simple voting mechanism where an administrator can initialize it with an array of proposals to vote on by using the ",(0,a.kt)("inlineCode",{parentName:"p"},"initializeProposals")," function."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cadence"},'// function to initialize all the proposals for the voting\npub fun initializeProposals(_ proposals: [String]) {\n    pre {\n        ApprovalVoting.proposals.length == 0: "Proposals can only be initialized once"\n        proposals.length > 0: "Cannot initialize with no proposals"\n    }\n    ApprovalVoting.proposals = proposals\n\n    // Set each tally of votes to zero\n    var i = 0\n    while i < proposals.length {\n        ApprovalVoting.votes[i] = 0\n        i = i + 1\n    }\n}\n')),(0,a.kt)("p",null,"Then they can give ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," resources to other accounts. The other accounts can record their votes on their ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," resource by calling the ",(0,a.kt)("inlineCode",{parentName:"p"},"vote")," function."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cadence"},'pub fun vote(proposal: Int) {\n    pre {\n        self.proposals[proposal] != nil: "Cannot vote for a proposal that doesn\'t exist"\n    }\n    self.choices[proposal] = true\n}\n')),(0,a.kt)("p",null,"After a user has voted, they submit their vote to the central smart contract by calling the ",(0,a.kt)("inlineCode",{parentName:"p"},"cast")," function, which records the votes in the ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," and destroys the used ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cadence"},"// A user moves their ballot to this function in the contract where\n// its votes are tallied and the ballot is destroyed\npub fun cast(ballot: @Ballot) {\n    var index = 0\n    // look through the ballot\n    while index < self.proposals.length {\n        if ballot.choices[index]! {\n            // tally the vote if it is approved\n            self.votes[index] = self.votes[index]! + 1\n        }\n        index = index + 1;\n    }\n    // Destroy the ballot because it has been tallied\n    destroy ballot\n}\n")),(0,a.kt)("p",null,"When the voting time ends, the administrator can read the tallies for each proposal to see if a proposal has received the right number of votes."),(0,a.kt)("h2",{id:"perform-voting"},"Perform Voting"),(0,a.kt)("p",null,"Performing the common actions in this voting contract only takes three types of transactions."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Initialize Proposals"),(0,a.kt)("li",{parentName:"ol"},"Send ",(0,a.kt)("inlineCode",{parentName:"li"},"Ballot")," to a voter"),(0,a.kt)("li",{parentName:"ol"},"Cast Vote")),(0,a.kt)("p",null,"We have a transaction for each step that we provide for you."),(0,a.kt)(p,{type:"info",mdxType:"Callout"},(0,a.kt)("p",null,'"You should have the ApprovalVoting already deployed to account ',(0,a.kt)("inlineCode",{parentName:"p"},"0x01"),".",(0,a.kt)("br",null),"\nOpen Transaction 1 which should have ",(0,a.kt)("inlineCode",{parentName:"p"},"Transaction1.cdc"),(0,a.kt)("br",null),"\nSubmit the transaction with account ",(0,a.kt)("inlineCode",{parentName:"p"},"0x01")," selected as the only signer.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cadence:title=Transaction1.cdc"},'import ApprovalVoting from 0x01\n\n// This transaction allows the administrator of the Voting contract\n// to create new proposals for voting and save them to the smart contract\n\ntransaction {\n    prepare(admin: AuthAccount) {\n\n        // borrow a reference to the admin Resource\n        let adminRef = admin.borrow<&ApprovalVoting.Administrator>(from: /storage/VotingAdmin)!\n\n        // Call the initializeProposals function\n        // to create the proposals array as an array of strings\n        adminRef.initializeProposals(\n            ["Longer Shot Clock", "Trampolines instead of hardwood floors"]\n        )\n\n        log("Proposals Initialized!")\n    }\n\n    post {\n        ApprovalVoting.proposals.length == 2\n    }\n\n}\n')),(0,a.kt)("p",null,"This transaction allows the administrator of the Voting contract to create new proposals for voting and save them to the smart contract. They do this by calling the ",(0,a.kt)("inlineCode",{parentName:"p"},"initializeProposals")," function on their stored ",(0,a.kt)("inlineCode",{parentName:"p"},"Administrator")," resource, giving it two new proposals to vote on.\nWe use the ",(0,a.kt)("inlineCode",{parentName:"p"},"post")," block to ensure that there were two proposals created, like we wished for."),(0,a.kt)("p",null,"Next, the administrator needs to hand out Ballots to the voters. There isn't an easy ",(0,a.kt)("inlineCode",{parentName:"p"},"deposit")," function this time for them to send a ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," to another account, so how would they do it? This is where multiple-transaction signers can come in handy!"),(0,a.kt)("h2",{id:"selecting-multiple-accounts-as-signers"},"Selecting multiple Accounts as Signers"),(0,a.kt)("p",null,"A transaction has access to the private account objects of every account that signed it, so if both the admin and the voter sign a transaction, the admin can directly move a ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," resource object to the other account's storage."),(0,a.kt)("p",null,"In the Flow playground, you can select multiple accounts to sign a transaction to be able to access the private account objects of both accounts."),(0,a.kt)("p",null,"To select multiple signers, you first need to include two arguments in the ",(0,a.kt)("inlineCode",{parentName:"p"},"prepare")," block of your transaction:"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"prepare(acct1: AuthAccount, acct2: AuthAccount)")),(0,a.kt)("p",null,"The playground will give you an error if the number of selected signers is different than the number of arguments to the prepare block. The playground also maps the accounts you select as signers to the arguments in the order that you select them. The first account you select will be the first argument, and the second account you select is the second argument."),(0,a.kt)(p,{type:"info",mdxType:"Callout"},(0,a.kt)("p",null,"Open Transaction 2 which should have ",(0,a.kt)("inlineCode",{parentName:"p"},"Transaction2.cdc"),".",(0,a.kt)("br",null),"\nSelect account ",(0,a.kt)("inlineCode",{parentName:"p"},"0x01")," as a signer first, then also select account ",(0,a.kt)("inlineCode",{parentName:"p"},"0x02"),". ",(0,a.kt)("br",null),"\nSubmit the transaction by clicking the ",(0,a.kt)("inlineCode",{parentName:"p"},"Send")," button")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cadence:title=Transaction2.cdc"},"\nimport ApprovalVoting from 0x01\n\n// This transaction allows the administrator of the Voting contract\n// to create a new ballot and store it in a voter's account\n// The voter and the administrator have to both sign the transaction\n// so it can access their storage\n\ntransaction {\n    prepare(admin: AuthAccount, voter: AuthAccount) {\n\n        // borrow a reference to the admin Resource\n        let adminRef = admin.borrow<&ApprovalVoting.Administrator>(from: /storage/VotingAdmin)!\n\n        // create a new Ballot by calling the issueBallot\n        // function of the admin Reference\n        let ballot <- adminRef.issueBallot()\n\n        // store that ballot in the voter's account storage\n        voter.save<@ApprovalVoting.Ballot>(<-ballot, to: /storage/Ballot)\n\n        log(\"Ballot transferred to voter\")\n    }\n}\n\n")),(0,a.kt)("p",null,"This transaction has two signers as ",(0,a.kt)("inlineCode",{parentName:"p"},"prepare")," parameters, so it is able to access both of their private ",(0,a.kt)("inlineCode",{parentName:"p"},"AuthAccount")," objects, and therefore their private account storage. Because of this, we can perform a direct transfer of the ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," by creating it with the admin's ",(0,a.kt)("inlineCode",{parentName:"p"},"issueBallot")," function and then directly store it in the voter's storage by using the ",(0,a.kt)("inlineCode",{parentName:"p"},"save")," function."),(0,a.kt)("p",null,"Account ",(0,a.kt)("inlineCode",{parentName:"p"},"0x02")," should now have a ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," resource object in its account storage. You can confirm this by opening the account 2 tab and seeing the ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," resource shown in the Resources box."),(0,a.kt)("h2",{id:"casting-a-vote"},"Casting a Vote"),(0,a.kt)("p",null,"Now that account ",(0,a.kt)("inlineCode",{parentName:"p"},"0x02")," has a ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," in their storage, they can cast their vote. To do this, they will call the ",(0,a.kt)("inlineCode",{parentName:"p"},"vote")," method on their stored resource, then cast that ",(0,a.kt)("inlineCode",{parentName:"p"},"Ballot")," by passing it to the ",(0,a.kt)("inlineCode",{parentName:"p"},"cast")," function in the main smart contract."),(0,a.kt)(p,{type:"info",mdxType:"Callout"},(0,a.kt)("p",null,"Open Transaction 3 which should contain ",(0,a.kt)("inlineCode",{parentName:"p"},"Transaction3.cdc"),".",(0,a.kt)("br",null),"\nSelect account ",(0,a.kt)("inlineCode",{parentName:"p"},"0x02")," as the only transaction signer",(0,a.kt)("br",null),"\nClick the ",(0,a.kt)("inlineCode",{parentName:"p"},"send")," button to submit the transaction.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cadence:title=Transaction3.cdc"},'import ApprovalVoting from 0x01\n\n// This transaction allows a voter to select the votes they would like to make\n// and cast that vote by using the castVote function\n// of the ApprovalVoting smart contract\n\ntransaction {\n    prepare(voter: AuthAccount) {\n\n        // take the voter\'s ballot our of storage\n        let ballot <- voter.load<@ApprovalVoting.Ballot>(from: /storage/Ballot)!\n\n        // Vote on the proposal\n        ballot.vote(proposal: 1)\n\n        // Cast the vote by submitting it to the smart contract\n        ApprovalVoting.cast(ballot: <-ballot)\n\n        log("Vote cast and tallied")\n    }\n}\n')),(0,a.kt)("p",null,"In this transaction, the user votes for one of the proposals, and then moves their Ballot back to the smart contract where the vote is tallied."),(0,a.kt)("h2",{id:"reading-the-result-of-the-vote"},"Reading the result of the vote"),(0,a.kt)("p",null,"At any time, anyone could read the current tally of votes by directly reading the fields of the contract. You can use a script to do that, since it does not need to modify storage."),(0,a.kt)(p,{type:"info",mdxType:"Callout"},(0,a.kt)("p",null,"Open a Script 1 which should contain the code below.",(0,a.kt)("br",null),"\nClick the ",(0,a.kt)("inlineCode",{parentName:"p"},"execute")," button to run the script.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cadence:title=Script1.cdc"},'import ApprovalVoting from 0x01\n\n// This script allows anyone to read the tallied votes for each proposal\n//\n\npub fun main() {\n\n    // Access the public fields of the contract to log\n    // the proposal names and vote counts\n\n    log("Number of Votes for Proposal 1:")\n    log(ApprovalVoting.proposals[0])\n    log(ApprovalVoting.votes[0])\n\n    log("Number of Votes for Proposal 2:")\n    log(ApprovalVoting.proposals[1])\n    log(ApprovalVoting.votes[1])\n\n}\n')),(0,a.kt)("p",null,"You should see something like this print:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'"Number of Votes for Proposal 1:"\n"Longer Shot Clock"\n0\n"Number of Votes for Proposal 2:"\n"Trampolines instead of hardwood floors"\n1\n')),(0,a.kt)("p",null,"This shows that one vote was cast for proposal 1 and no votes were cast for proposal 2."),(0,a.kt)("h2",{id:"other-voting-possibilities"},"Other Voting possibilities"),(0,a.kt)("p",null,"This contract was a very simple example of voting in Cadence. It clearly couldn't be used for a real-world voting situation, but hopefully you can see what kind of features could be added to it to ensure practicality and security."))}m.isMDXComponent=!0}}]);